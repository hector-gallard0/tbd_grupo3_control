WITH table1 AS (SELECT t.id_peluqueria, t.nombre_peluqueria, t.hora_inicio, count(*) AS qty
FROM (
	SELECT p.id_peluqueria, p.nombre_peluqueria, c.fecha_cita, h.hora_inicio, co.nombre_comuna
	FROM cita c, cliente_peluqueria cp, peluqueria p, comuna co, horario h
	WHERE c.id_cliente_peluqueria = cp.id_cliente_peluqueria
	AND cp.id_peluqueria = p.id_peluqueria
	AND p.id_comuna = co.id_comuna
	AND c.id_horario = h.id_horario
	ORDER BY p.nombre_peluqueria
) as t
GROUP BY (t.id_peluqueria, t.nombre_peluqueria, t.hora_inicio)
)

SELECT t.id_peluqueria, t.nombre_peluqueria, t.hora_inicio, t.qty
FROM table1 t
WHERE qty = (
	SELECT MIN(qty)
	FROM table1 t2
	WHERE t2.id_peluqueria = t.id_peluqueria 
)
ORDER BY id_peluqueria


2.	lista de clientes que gastan más dinero mensual por peluquería, indicando comuna del cliente y de peluquería, además de cuanto gasto
select t3.id_peluqueria, t3.mes_detalle, t3.ano_detalle, t3.id_cliente, t3.precio_detalle, co.nombre_comuna
from
	(select t1.id_peluqueria, t1.mes_detalle, t1.ano_detalle, max(t1.precio_detalle) as max_precio_detalle
	from
		(select 
			p.id_peluqueria,
			extract(month from ci.fecha_cita) as mes_detalle, 
			extract(year from ci.fecha_cita) as ano_detalle, 
			c.id_cliente, 
			sum(d.precio_detalle) as precio_detalle
		from cliente c, cliente_peluqueria cp, cita ci, detalle d, peluqueria p
		where p.id_peluqueria = cp.id_peluqueria
		and c.id_cliente = cp.id_cliente
		and cp.id_cliente_peluqueria = ci.id_cliente_peluqueria
		and ci.id_cita = d.id_cita		
		group by(p.id_peluqueria, c.id_cliente, extract(month from ci.fecha_cita), extract(year from ci.fecha_cita))
		order by id_peluqueria, mes_detalle, ano_detalle) as t1
	 group by(t1.id_peluqueria, t1.mes_detalle, t1.ano_detalle)
	) as t2
join
	(select 
		p.id_peluqueria,
		extract(month from ci.fecha_cita) as mes_detalle, 
		extract(year from ci.fecha_cita) as ano_detalle, 
		c.id_cliente, 
		sum(d.precio_detalle) as precio_detalle
	from cliente c, cliente_peluqueria cp, cita ci, detalle d, peluqueria p
	where p.id_peluqueria = cp.id_peluqueria
	and c.id_cliente = cp.id_cliente
	and cp.id_cliente_peluqueria = ci.id_cliente_peluqueria
	and ci.id_cita = d.id_cita		
	group by(p.id_peluqueria, c.id_cliente, extract(month from ci.fecha_cita), extract(year from ci.fecha_cita))
	order by id_peluqueria, mes_detalle, ano_detalle
	) as t3
on t2.id_peluqueria = t3.id_peluqueria
and t2.mes_detalle = t3.mes_detalle
and t2.ano_detalle = t3.ano_detalle
and t2.max_precio_detalle = t3.precio_detalle
join cliente cl
on cl.id_cliente = t3.id_cliente
join comuna co
on co.id_comuna = cl.id_comuna
order by (t3.id_peluqueria, t3.mes_detalle, t3.ano_detalle)





3.	lista de peluqueros que ha ganado más por mes los últimos 3 años, esto por peluquería
peluqueria	|mes	|ano	|peluquero



4.	lista de clientes hombres que se cortan el pelo y la barba


SELECT DISTINCT cl.id_cliente, cl.nombre
FROM  cliente cl
JOIN cliente_peluqueria cp
ON cl.id_cliente = cp.id_cliente
JOIN cita ci
ON cp.id_cliente_peluqueria = ci.id_cliente_peluqueria
JOIN detalle d
ON d.id_cita = ci.id_cita
JOIN servicio s
ON s.id_servicio = 2 OR s.id_servicio = 3
JOIN detalle_servicio ds
ON ds.id_detalle = d.id_detalle
AND ds.id_servicio = s.id_servicio 
JOIN detalle_servicio ds1
ON ds1.id_servicio = 
	(CASE
		WHEN ds.id_servicio = 2 THEN 3
		WHEN ds.id_servicio = 3 THEN 2
	 END
 	)
AND ds.id_detalle = ds1.id_detalle
WHERE cl.sexo = 'M'
order by cl.id_cliente


5.	lista de clientes que se tiñen el pelo, indicando la comuna del cliente, la peluquería donde se atendió y el valor que pagó


SELECT cl.id_cliente, cl.nombre, co.nombre_comuna, pe.nombre_peluqueria, s.precio_servicio
FROM cliente cl
JOIN cliente_peluqueria cp
ON cl.id_cliente = cp.id_cliente
JOIN cita ci
ON cp.id_cliente_peluqueria = ci.id_cliente_peluqueria
JOIN peluqueria pe
ON pe.id_peluqueria = cp.id_peluqueria
JOIN detalle d
ON d.id_cita = ci.id_cita
JOIN detalle_servicio ds
ON d.id_detalle = ds.id_detalle
JOIN comuna co
ON cl.id_comuna = co.id_comuna
JOIN servicio s
ON s.id_servicio = ds.id_servicio
WHERE ds.id_servicio = 4
GROUP BY cl.id_cliente, cl.nombre, co.nombre_comuna, pe.nombre_peluqueria, s.precio_servicio
ORDER BY cl.id_cliente

*Considerando que todos los clientes han recibido este servicio, con el siguiente script se pueden borrar los tintes de cabello realizados
por el cliente de id 1 para poder comprobar la query que responde a la pregunta 5 con mayor facilidad, pues dejará de mostrar en sus 
resultados a este cliente.

DELETE FROM Detalle_servicio
WHERE id_detalle IN (
    SELECT id_detalle
    FROM Detalle
    WHERE id_cita IN (
        SELECT id_cita
        FROM Cita
        WHERE id_cliente_peluqueria = 1
    )
) AND id_servicio = 4;


6.	identificar el horario más concurrido por peluquería durante el 2018 y 2029, desagregados por mes
-- año mes 
WITH t1 AS(
	SELECT t1.nombre_peluqueria, t1.ano, t1.mes, MAX(t1.num_citas) as max_num_citas
	FROM (
		SELECT 
			pe.nombre_peluqueria,
			EXTRACT(YEAR FROM ci.fecha_cita) as ano, 
			EXTRACT(MONTH FROM ci.fecha_cita) as mes,
			h.hora_inicio,
			count(*) as num_citas
		FROM peluqueria pe
		JOIN cliente_peluqueria cp
		ON pe.id_peluqueria = cp.id_peluqueria
		JOIN cita ci
		ON cp.id_cliente_peluqueria = ci.id_cliente_peluqueria
		JOIN horario h
		ON ci.id_horario = h.id_horario
		GROUP BY 
			(pe.nombre_peluqueria,
			EXTRACT(YEAR FROM ci.fecha_cita), 
			EXTRACT(MONTH FROM ci.fecha_cita),
			h.hora_inicio)
		ORDER BY pe.nombre_peluqueria) AS t1
	GROUP BY t1.nombre_peluqueria, t1.ano, t1.mes
)

SELECT DISTINCT ON (t1.nombre_peluqueria, t1.ano, t1.mes)
	t1.nombre_peluqueria, t1.ano, t1.mes, t2.hora_inicio, t1.max_num_citas
FROM t1
JOIN (
	SELECT 
			pe.nombre_peluqueria,
			EXTRACT(YEAR FROM ci.fecha_cita) as ano, 
			EXTRACT(MONTH FROM ci.fecha_cita) as mes,
			h.hora_inicio,
			count(*) as num_citas
		FROM peluqueria pe
		JOIN cliente_peluqueria cp
		ON pe.id_peluqueria = cp.id_peluqueria
		JOIN cita ci
		ON cp.id_cliente_peluqueria = ci.id_cliente_peluqueria
		JOIN horario h
		ON ci.id_horario = h.id_horario
		GROUP BY 
			(pe.nombre_peluqueria,
			EXTRACT(YEAR FROM ci.fecha_cita), 
			EXTRACT(MONTH FROM ci.fecha_cita),
			h.hora_inicio)
		ORDER BY pe.nombre_peluqueria) as t2
ON t1.nombre_peluqueria = t2.nombre_peluqueria
AND t1.ano = t2.ano
AND t1.mes = t2.mes
AND t1.max_num_citas = t2.num_citas

7.	identificar al cliente que ha tenido las citas más largas por peluquería, por mes
WITH t2 AS (
	SELECT t1.nombre_peluqueria, t1.ano, t1.mes, MAX(duracion_cita) as max_duracion_cita
	FROM (
		SELECT 
			pe.nombre_peluqueria, 
			EXTRACT(YEAR FROM ci.fecha_cita) AS ano, 
			EXTRACT(MONTH FROM ci.fecha_cita) AS mes,
			cl.nombre,
			ci.duracion_cita
		FROM peluqueria pe
		JOIN cliente_peluqueria cp
		ON pe.id_peluqueria = cp.id_peluqueria
		JOIN cliente cl
		ON cl.id_cliente = cp.id_cliente
		JOIN cita ci
		ON cp.id_cliente_peluqueria = ci.id_cliente_peluqueria
		ORDER BY 
			pe.nombre_peluqueria, 
			EXTRACT(YEAR FROM ci.fecha_cita), 
			EXTRACT(MONTH FROM ci.fecha_cita)) as t1
GROUP BY t1.nombre_peluqueria, t1.ano, t1.mes)

SELECT t2.nombre_peluqueria, t2.ano, t2.mes, t3.id_cliente, t3.nombre, t2.max_duracion_cita
FROM t2
JOIN (
	SELECT 
		pe.nombre_peluqueria, 
		EXTRACT(YEAR FROM ci.fecha_cita) AS ano, 
		EXTRACT(MONTH FROM ci.fecha_cita) AS mes,
		cl.nombre,
		cl.id_cliente,
		ci.duracion_cita
	FROM peluqueria pe
	JOIN cliente_peluqueria cp
	ON pe.id_peluqueria = cp.id_peluqueria
	JOIN cliente cl
	ON cl.id_cliente = cp.id_cliente
	JOIN cita ci
	ON cp.id_cliente_peluqueria = ci.id_cliente_peluqueria
	ORDER BY 
		pe.nombre_peluqueria, 
		EXTRACT(YEAR FROM ci.fecha_cita), 
		EXTRACT(MONTH FROM ci.fecha_cita)
) as t3
ON t2.nombre_peluqueria = t3.nombre_peluqueria
AND t2.ano = t3.ano
AND t2.mes = t3.mes
AND t2.max_duracion_cita = t3.duracion_cita

8.	identificar servicio más caro por peluquería
WITH t2 AS
	(SELECT t1.nombre_peluqueria, MAX(precio_servicio) as max_precio_servicio
	FROM
		(SELECT DISTINCT ON(pe.nombre_peluqueria, s.nombre_servicio)
			pe.nombre_peluqueria, s.nombre_servicio, s.precio_servicio
		FROM peluqueria pe
		JOIN cliente_peluqueria cp
		ON pe.id_peluqueria = cp.id_peluqueria
		JOIN cita ci
		ON cp.id_cliente_peluqueria = ci.id_cliente_peluqueria
		JOIN detalle d
		ON ci.id_cita = d.id_cita
		JOIN detalle_servicio ds
		ON ds.id_detalle = d.id_detalle
		JOIN servicio s
		ON s.id_servicio = ds.id_servicio) AS t1
	GROUP BY (t1.nombre_peluqueria))
	
SELECT DISTINCT ON(t2.nombre_peluqueria) 
	t2.nombre_peluqueria, t3.nombre_servicio, t2.max_precio_servicio
FROM t2
JOIN (
	SELECT DISTINCT ON(pe.nombre_peluqueria, s.nombre_servicio)
			pe.nombre_peluqueria, s.nombre_servicio, s.precio_servicio
	FROM peluqueria pe
	JOIN cliente_peluqueria cp
	ON pe.id_peluqueria = cp.id_peluqueria
	JOIN cita ci
	ON cp.id_cliente_peluqueria = ci.id_cliente_peluqueria
	JOIN detalle d
	ON ci.id_cita = d.id_cita
	JOIN detalle_servicio ds
	ON ds.id_detalle = d.id_detalle
	JOIN servicio s
	ON s.id_servicio = ds.id_servicio
) as t3
ON t2.nombre_peluqueria = t3.nombre_peluqueria
AND t2.max_precio_servicio = t3.precio_servicio


9.	identificar al peluquero que ha trabajado más por mes durante el 2021
WITH t1 AS (
	SELECT t2.mes, MAX(t2.duracion_cita_mes) as max_duracion_cita_mes
	FROM
		(SELECT 
			p.id_peluquero, 
			EXTRACT(YEAR FROM ci.fecha_cita) as ano,
			EXTRACT(MONTH FROM ci.fecha_cita) as mes, 
			SUM(ci.duracion_cita) AS duracion_cita_mes
		FROM peluqueria pe
		JOIN cliente_peluqueria cp
		ON pe.id_peluqueria = cp.id_peluqueria
		JOIN cita ci
		ON cp.id_cliente_peluqueria = ci.id_cliente_peluqueria
		JOIN peluquero p
		ON p.id_peluquero = ci.id_peluquero
		GROUP BY
			p.id_peluquero, 
			EXTRACT(MONTH FROM ci.fecha_cita),
			EXTRACT(YEAR FROM ci.fecha_cita) 
		HAVING EXTRACT(YEAR FROM ci.fecha_cita) = '2021'
		ORDER BY p.id_peluquero) AS t2
	GROUP BY t2.mes)

SELECT t1.mes, t2.id_peluquero, t1.max_duracion_cita_mes
FROM t1
JOIN (
	(SELECT 
			p.id_peluquero, 
			EXTRACT(YEAR FROM ci.fecha_cita) as ano,
			EXTRACT(MONTH FROM ci.fecha_cita) as mes, 
			SUM(ci.duracion_cita) AS duracion_cita_mes
		FROM peluqueria pe
		JOIN cliente_peluqueria cp
		ON pe.id_peluqueria = cp.id_peluqueria
		JOIN cita ci
		ON cp.id_cliente_peluqueria = ci.id_cliente_peluqueria
		JOIN peluquero p
		ON p.id_peluquero = ci.id_peluquero
		GROUP BY
			p.id_peluquero, 
			EXTRACT(MONTH FROM ci.fecha_cita),
			EXTRACT(YEAR FROM ci.fecha_cita) 
		HAVING EXTRACT(YEAR FROM ci.fecha_cita) = '2021'
		ORDER BY p.id_peluquero)
) as t2
ON t1.mes = t2.mes
AND t1.max_duracion_cita_mes = duracion_cita_mes

10.	identificar lista de totales por comuna, cantidad de peluquerías, cantidad de clientes residentes en la comuna
